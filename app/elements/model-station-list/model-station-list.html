<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/baasic-crud/baasic-crud.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">

<polymer-element name="model-station-list" attributes="">
    <template>
        <baasic-crud id="crudElement"
            geturl="{{baseUrl}}/{{version}}/station/"
            on-get-completed="{{handleGetCompleted}}"
            on-get-error="{{handleGetError}}">
        </baasic-crud>
        <paper-input floatingLabel="true" label="Search station" value="{{search}}"></paper-input>

        <h4>Found {{pks.length}} station<template if="{{pks.length!=1}}">s</template></h4>
        <ul>
            <template repeat="{{d in dataToShow}}">
                <model-station id="station-{{d.stationId}}" pk="{{d.stationId}}"></model-station>
            </template>
        </ul>
        <template if="{{data.length > 10}}">
            <p>Only showing 10 stations...</p>
        </template>
    </template>
    <script>
        (function () {
            Polymer('model-station-list', {
                baseUrl: 'http://localhost:8000/api',
                version: 'v1',
                data: [],
                search: '',
                extractKeys: function(list, keyName) {
                    return list.map(function(x) {return x[keyName];});
                },
                calcDataToShow: function(data) {
                    if(data.length > 10) {
                        return data.slice(0, 10);
                    } else {
                        return data;
                    }
                },
                computed: {
                    pks: 'extractKeys(data, "stationId")',
                    dataToShow: 'calcDataToShow(data)',
                },
                domReady: function() {
                    return this.refresh();
                },
                searchChanged: function(oldValue, newValue){
                    clearTimeout(this.searchChangeTimeout);
                    this.searchChangeTimeout = window.setTimeout(this.refresh.bind(this), 500);
                },
                refresh: function() {
                    var params = {};
                    if(this.search.length) {
                        params = {search: this.search};
                    }
                    return this.$.crudElement.get(params);
                },
                handleGetCompleted: function(e, response, element) {
                    this.data = response.response;
                },
                handleGetError: function(e, response, element) {
                    console.log({handleGetError: response});
                    document.querySelector('#userNotifier').notify('Error getting station list');
                },
            });
        })();
    </script>
</polymer-element>
